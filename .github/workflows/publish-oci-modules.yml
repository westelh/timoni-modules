name: publish-oci-modules

on:
  push:
    tags:
      - '*/*'

permissions:
  contents: read
  packages: write

env:
  TIMONI_VERSION: latest

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Timoni
        uses: stefanprodan/timoni/actions/setup@main
        with:
          version: latest

      - name: Run Timoni
        run: timoni version

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Vet module
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          semver_re='(0|[1-9][0-9]*)\\.(0|[1-9][0-9]*)\\.(0|[1-9][0-9]*)(-((0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*)(\\.(0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*))*))?(\\+([0-9a-zA-Z-]+(\\.[0-9a-zA-Z-]+)*))?'
          if ! [[ "$TAG_NAME" =~ ^[^/]+/v${semver_re}$ ]]; then
            echo "Invalid tag '$TAG_NAME'. Expected '<module>/vX.Y.Z' with optional prerelease/build metadata."
            exit 1
          fi

          module="${TAG_NAME%%/v*}"

          if [ -z "$module" ] || [ "$module" = "$TAG_NAME" ]; then
            echo "Invalid tag '$TAG_NAME'. Expected '<module>/vX.Y.Z'."
            exit 1
          fi

          if [ ! -d "$module" ]; then
            echo "Module directory '$module' not found."
            exit 1
          fi

          timoni mod vet "./$module"

      - name: Publish module
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          semver_re='(0|[1-9][0-9]*)\\.(0|[1-9][0-9]*)\\.(0|[1-9][0-9]*)(-((0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*)(\\.(0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*))*))?(\\+([0-9a-zA-Z-]+(\\.[0-9a-zA-Z-]+)*))?'
          if ! [[ "$TAG_NAME" =~ ^[^/]+/v${semver_re}$ ]]; then
            echo "Invalid tag '$TAG_NAME'. Expected '<module>/vX.Y.Z' with optional prerelease/build metadata."
            exit 1
          fi

          module="${TAG_NAME%%/v*}"
          version="${TAG_NAME#*/}"

          if [ -z "$module" ] || [ "$module" = "$TAG_NAME" ]; then
            echo "Invalid tag '$TAG_NAME'. Expected '<module>/vX.Y.Z'."
            exit 1
          fi

          if [ ! -d "$module" ]; then
            echo "Module directory '$module' not found."
            exit 1
          fi

          echo "Publishing module '$module' version '$version'"
          timoni mod push "./$module" "oci://ghcr.io/westelh/timoni/modules/$module" \
            --version "$version" \
            --latest \
            -a "org.opencontainers.image.title=timoni-$module" \
            -a "org.opencontainers.image.description=Timoni module $module." \
            -a "org.opencontainers.image.licenses=Apache-2.0" \
            -a "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
            -a "org.opencontainers.image.url=https://github.com/${{ github.repository }}"
